name: Rawafid Android CI & Detailed Telegram Notifier

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Send 'Build Triggered' Notification
        run: >
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"
          -d chat_id="${{ secrets.TELEGRAM_TO }}"
          -d text="ğŸš€ *ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©* Ù„Ù…Ø´Ø±ÙˆØ¹ Rawafid.
          *Ø§Ù„ÙØ±Ø¹:* `${{ github.ref_name }}`
          *Ø§Ù„Ù€ Commit:* `${{ github.sha }}`
          [Ø¹Ø±Ø¶ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
          -d parse_mode="Markdown"

      - name: 2. Checkout Repository
        uses: actions/checkout@v4

      - name: 3. Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 4. Notify before Build
        run: >
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"
          -d chat_id="${{ secrets.TELEGRAM_TO }}"
          -d text="â³ *Ø¬Ø§Ø±ÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gradle...*
          Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø¯Ù‚Ø§Ø¦Ù‚."
          -d parse_mode="Markdown"

      - name: 5. Build with Gradle
        id: build_step
        continue-on-error: true
        run: |
          chmod +x ./gradlew
          ./gradlew :app:assembleDebug > gradle_output.log 2>&1

      - name: 6. Extract Error Log
        if: steps.build_step.outcome == 'failure'
        id: error_log
        run: |
          echo "ERROR_DETAILS=$(tail -n 30 gradle_output.log | sed 's/"/\\"/g' | sed "s/'/\\'/g" | sed ':a;N;$!ba;s/\n/\\n/g')" >> $GITHUB_ENV

      - name: 7. Send Final Result to Telegram
        run: |
          BUILD_LOG_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [ "${{ steps.build_step.outcome }}" == "success" ]; then
            MESSAGE="âœ… *Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!*

            - *Ø§Ù„Ù…Ù„Ù:* `app-debug.apk`
            - [Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡]($BUILD_LOG_URL)

            *Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù€ APK...*"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" -d chat_id="${{ secrets.TELEGRAM_TO }}" -d text="$MESSAGE" -d parse_mode="Markdown"
            
            curl -s -F document=@"app/build/outputs/apk/debug/app-debug.apk" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument?chat_id=${{ secrets.TELEGRAM_TO }}"
          else
            MESSAGE="âŒ *ÙØ´Ù„ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹!*

            - [Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„]($BUILD_LOG_URL)

            *Ø¢Ø®Ø± Ø£Ø³Ø·Ø± Ù…Ù† Ø§Ù„Ø®Ø·Ø£:*
            \`\`\`
            ${{ env.ERROR_DETAILS }}
            \`\`\`"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" -d chat_id="${{ secrets.TELEGRAM_TO }}" -d text="$MESSAGE" -d parse_mode="Markdown"
            exit 1
          fi
