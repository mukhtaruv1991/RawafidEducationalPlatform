name: Rawafid Android CI & Detailed Telegram Notifier

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Send 'Build Triggered' Notification
        run: >
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"
          -d chat_id="${{ secrets.TELEGRAM_TO }}"
          -d text="🚀 *تم تفعيل عملية بناء جديدة* لمشروع Rawafid.
          *الفرع:* `${{ github.ref_name }}`
          *الـ Commit:* `${{ github.sha }}`
          [عرض التغييرات](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
          -d parse_mode="Markdown"

      - name: 2. Checkout Repository
        uses: actions/checkout@v4

      - name: 3. Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 4. Notify before Build
        run: >
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"
          -d chat_id="${{ secrets.TELEGRAM_TO }}"
          -d text="⏳ *جاري بناء المشروع باستخدام Gradle...*
          هذه الخطوة قد تستغرق بضع دقائق."
          -d parse_mode="Markdown"

      - name: 5. Build with Gradle
        id: build_step
        continue-on-error: true
        run: |
          chmod +x ./gradlew
          ./gradlew :app:assembleDebug > gradle_output.log 2>&1

      - name: 6. Extract Error Log
        if: steps.build_step.outcome == 'failure'
        id: error_log
        run: |
          echo "ERROR_DETAILS=$(tail -n 30 gradle_output.log | sed 's/"/\\"/g' | sed "s/'/\\'/g" | sed ':a;N;$!ba;s/\n/\\n/g')" >> $GITHUB_ENV

      - name: 7. Send Final Result to Telegram
        run: |
          BUILD_LOG_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [ "${{ steps.build_step.outcome }}" == "success" ]; then
            MESSAGE="✅ *اكتمل البناء بنجاح!*

            - *الملف:* `app-debug.apk`
            - [عرض سجل البناء]($BUILD_LOG_URL)

            *جاري رفع ملف الـ APK...*"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" -d chat_id="${{ secrets.TELEGRAM_TO }}" -d text="$MESSAGE" -d parse_mode="Markdown"
            
            curl -s -F document=@"app/build/outputs/apk/debug/app-debug.apk" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument?chat_id=${{ secrets.TELEGRAM_TO }}"
          else
            MESSAGE="❌ *فشل بناء المشروع!*

            - [عرض السجل الكامل]($BUILD_LOG_URL)

            *آخر أسطر من الخطأ:*
            \`\`\`
            ${{ env.ERROR_DETAILS }}
            \`\`\`"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" -d chat_id="${{ secrets.TELEGRAM_TO }}" -d text="$MESSAGE" -d parse_mode="Markdown"
            exit 1
          fi
